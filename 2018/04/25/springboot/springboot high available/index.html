<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="姚杰的博客"><title>搭建springboot的高可用框架，其中包含了mysql，redis，kakfa，log4j等 | 雨中风筝</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">搭建springboot的高可用框架，其中包含了mysql，redis，kakfa，log4j等</h1><a id="logo" href="/.">雨中风筝</a><p class="description">雨，淅淅沥沥的下；风筝，摇曳穿梭</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">搭建springboot的高可用框架，其中包含了mysql，redis，kakfa，log4j等</h1><div class="post-meta">Apr 25, 2018<span> | </span><span class="category"><a href="/categories/springboot/">springboot</a></span></div><div class="post-content"><p>搭建springboot的高可用框架，其中包含了mysql，redis，kakfa，log4j等</p>
<p><strong>环境</strong></p>
<p>此次示例是在macos10.13.3的环境下</p>
<p>已经安装好docker；</p>
<p>mysql等软件均安装在docker下，以下演示</p>
<p>开发工具是spring的sts，使用了jdk8，springboot2.0.1</p>
<p>注：首先查询本地ip，放入/ect/hosts 文件中 <code>192.168.1.169 myhost</code></p>
<p>mysql5.6 读写分离主主自动切换</p>
<p>redis4.0.1 redisCluster集群</p>
<p>Springboot2.0.1 + mybatis(分页插件pagehelper)</p>
<p><strong>mysql+mycat 搭建数据库集群</strong></p>
<p>下载mysql的镜像<code>docker pull mysql:5.6</code></p>
<p><em>mysql主从自动备份和自动切换</em></p>
<p>​    从数据安全性考虑，对数据库的数据进行及时备份非常重要。mysql就提供了主从备份的机制，从数据库会非常及时的将主数据库的操作更新到从库上，从而当主数据库down掉之后，数据不会丢失；同时，也可以通过keepalived等程序来实现主库down掉之后，迅速将数据访问服务切换到从库，从而尽可能维护数据库服务的不间断运行。</p>
<p><em>mycat 数据库中间件</em></p>
<p>​    Mycat是一个彻底开源的新颖的数据库中间件产品。它的出现将彻底结束数据库的瓶颈问题，从而使数据库的高可用，高负载成为可能。Mycat功能强大，这里实现利用Mycat来实现主从数据库的读写分离和自动切换。mycat的单节点问题可以考虑Keepalived，暂时不做处理</p>
<ul>
<li>首先启动主从数据库</li>
</ul>
<p>首先在自己的主机上配置好mysql的配置文件my-m.cnf</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql.server]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld_safe]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pid-file</span> = /var/run/mysqld/mysqld.pid</span><br><span class="line"><span class="attr">socket</span>   = /var/run/mysqld/mysqld.sock</span><br><span class="line"><span class="attr">data</span>     = /var/lib/mysql</span><br><span class="line"></span><br><span class="line"><span class="attr">character_set_server</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主服务器</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_bin</span> = mysql-bin</span><br><span class="line"><span class="attr">lower_case_table_names</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>从my-s.cnf</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql.server]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld_safe]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pid-file</span> = /var/run/mysqld/mysqld.pid</span><br><span class="line"><span class="attr">socket</span>   = /var/run/mysqld/mysqld.sock</span><br><span class="line"><span class="attr">data</span>     = /var/lib/mysql</span><br><span class="line"></span><br><span class="line"><span class="attr">character_set_server</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从服务器</span></span><br><span class="line"><span class="attr">server-id</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">log_bin</span> = mysql-bin</span><br><span class="line"><span class="attr">lower_case_table_names</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>我们直接指定外部配置文件</p>
<p>主：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地映射地址/Users/yaojie/Documents/docker/mysql/master/</span></span><br><span class="line"><span class="comment"># 文件/Users/yaojie/Documents/docker/mysql/my-m.cnf</span></span><br><span class="line">docker run --restart=always -p <span class="number">3307</span>:<span class="number">3306</span> -v <span class="regexp">/Users/y</span>aojie<span class="regexp">/Documents/</span>docker<span class="regexp">/mysql/m</span>aster<span class="regexp">/:/</span>var<span class="regexp">/lib/my</span>sql -v <span class="regexp">/Users/y</span>aojie<span class="regexp">/Documents/</span>docker<span class="regexp">/mysql/my</span>-m.cnf:<span class="regexp">/etc/my</span>sql<span class="regexp">/mysql.conf.d/my</span>sqld.cnf -e MYSQL_ROOT_PASSWORD=<span class="number">123456</span> --name mysql-master -d mysql:<span class="number">5.6</span></span><br></pre></td></tr></table></figure>
<p>查看是否启动成功 <code>docker ps</code></p>
<p>进入容器<code>docker exec -it mysql-master /bin/bash</code></p>
<p>连接到mysql-master</p>
<p>查看用户名密码<code>mysql -u root -p</code>输入123456进入mysql</p>
<p>查看数据库字符集<code>mysql&gt;SHOW VARIABLES LIKE &#39;character_set_%&#39;;</code></p>
<p>查看collection的编码<code>mysql&gt;SHOW VARIABLES LIKE &#39;collation_%&#39;;</code></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 给从库设一个专门用的用户</span></span><br><span class="line">mysql&gt; grant replication slave <span class="keyword">on</span> *.* <span class="keyword">to</span> 'salves1' @'%' identified <span class="keyword">by</span> '<span class="number">123456</span>';  <span class="comment">-- %是指所有ip，这里可以指定具体ip</span></span><br><span class="line">mysql&gt; flush privileges; <span class="comment">-- 刷新MySQL的系统权限相关表;</span></span><br><span class="line">mysql&gt; select user,Host <span class="keyword">from</span> mysql.user;</span><br></pre></td></tr></table></figure>
<p>查看主库状态</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show <span class="keyword">master</span> <span class="title">status</span>;</span><br></pre></td></tr></table></figure>
<p>从：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地映射地址/Users/yaojie/Documents/docker/mysql/slave/</span></span><br><span class="line"><span class="comment"># 文件/Users/yaojie/Documents/docker/mysql/my-s.cnf</span></span><br><span class="line">docker run --restart=always -p <span class="number">3308</span>:<span class="number">3306</span> -v <span class="regexp">/Users/y</span>aojie<span class="regexp">/Documents/</span>docker<span class="regexp">/mysql/</span>slave<span class="regexp">/:/</span>var<span class="regexp">/lib/my</span>sql -v <span class="regexp">/Users/y</span>aojie<span class="regexp">/Documents/</span>docker<span class="regexp">/mysql/my</span>-s.cnf:<span class="regexp">/etc/my</span>sql<span class="regexp">/mysql.conf.d/my</span>sqld.cnf -e MYSQL_ROOT_PASSWORD=<span class="number">123456</span> --name mysql-slave -d mysql:<span class="number">5.6</span></span><br></pre></td></tr></table></figure>
<p>连接到mysql-slave</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">先测试下能否连接主数据库</span><br><span class="line">mysql -h myhost -P 3307 -u salves1 -p</span><br><span class="line">退出连接本地mysql再运行一下</span><br><span class="line">mysql&gt; change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'myhost'</span>,master_port=3307, <span class="attribute">master_user</span>=<span class="string">'salves1'</span>, <span class="attribute">master_password</span>=<span class="string">'123456'</span>,master_log_file='mysql-bin.000004',master_log_pos=400; -- master_log_file和master_log_pos是主库show master status获得的数据，必须统一</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status\G;  -- Slave_IO_Running和Slave_Sql_Running。这两个值为<span class="literal">Yes</span>，从库配置好了</span><br></pre></td></tr></table></figure>
<p>创建好之后，会发现master和slave之间会同步，比如master中创建数据库，slave中也会自动创建，在master中更改数据，slave中也会自动修改</p>
<ul>
<li>主主是从主从衍生而来的，可以从服务器给主服务器分配一个用户，让主服务器使用，这里直接使用root用户</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">从</span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">主</span><br><span class="line">mysql&gt; change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'myhost'</span>,master_port=3308, <span class="attribute">master_user</span>=<span class="string">'root'</span>, <span class="attribute">master_password</span>=<span class="string">'123456'</span>,master_log_file='mysql-bin.000004',master_log_pos=120;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure>
<p>这样就可以互为主从，即主主备份</p>
<ul>
<li>读写分离是mycat配置的</li>
</ul>
<p>前提，以上主主创建数据库</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">create</span> <span class="keyword">database</span> test_sb; # test_sb 以下需要配置</span><br></pre></td></tr></table></figure>
<p>安装mycat</p>
<p>编写Dockerfile</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">############################################</span><br><span class="line"># version : debugman007/c7-mycat:v1</span><br><span class="line"># desc : centos7 上安装的mycat</span><br><span class="line">############################################</span><br><span class="line"># 设置继承自 centos7 官方镜像</span><br><span class="line">FROM centos:<span class="number">7</span> </span><br><span class="line">RUN echo <span class="string">"root:root"</span> | chpasswd</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line"># install java</span><br><span class="line">ADD http:<span class="comment">//mirrors.linuxeye.com/jdk/jdk-7u80-linux-x64.tar.gz /usr/local/  </span></span><br><span class="line">RUN cd /usr/local &amp;&amp; tar -zxvf jdk<span class="number">-7</span>u80-linux-x64.tar.gz &amp;&amp; rm -f jdk<span class="number">-7</span>u80-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1<span class="number">.7</span><span class="number">.0</span>_80</span><br><span class="line">ENV CLASSPATH $&#123;JAVA_HOME&#125;/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">ENV PATH $PATH:$&#123;JAVA_HOME&#125;/bin</span><br><span class="line">#install mycat</span><br><span class="line">ADD http:<span class="comment">//dl.mycat.io/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz /usr/local</span></span><br><span class="line">RUN cd /usr/local &amp;&amp; tar -zxvf Mycat-server<span class="number">-1.6</span>-RELEASE<span class="number">-20161028204710</span>-linux.tar.gz &amp;&amp; rm -f Mycat-server<span class="number">-1.6</span>-RELEASE<span class="number">-20161028204710</span>-linux.tar.gz  </span><br><span class="line"></span><br><span class="line">VOLUME /usr/local/mycat/conf</span><br><span class="line">EXPOSE <span class="number">8066</span> <span class="number">9066</span></span><br><span class="line">CMD [<span class="string">"/usr/local/mycat/bin/mycat"</span>, <span class="string">"console"</span>]</span><br></pre></td></tr></table></figure>
<p>创建镜像</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t debugman007/<span class="built_in">c7</span>-mycat .</span><br></pre></td></tr></table></figure>
<p>运行容器</p>
<p>下载<a href="http://dl.mycat.io/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz" target="_blank" rel="noopener">http://dl.mycat.io/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz</a> 将conf文件夹复制到/Users/yaojie/Documents/docker/mycat/下，网盘下载<a href="https://pan.baidu.com/s/1Bq9oiTgVF3OFs3t11Ek4Cg" target="_blank" rel="noopener">https://pan.baidu.com/s/1Bq9oiTgVF3OFs3t11Ek4Cg</a></p>
<p>修改schema，读写分离，主从替换，修改database，writeHost，readHost</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"TESTDB"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1"</span> <span class="attr">dataHost</span>=<span class="string">"localhost1"</span> <span class="attr">database</span>=<span class="string">"test_sb"</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"localhost1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span> <span class="attr">writeType</span>=<span class="string">"0"</span>  </span></span><br><span class="line"><span class="tag">             <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span>  <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>show slave status<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- can have multi write hosts --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"myhost:3307"</span> <span class="attr">user</span>=<span class="string">"root"</span>  </span></span><br><span class="line"><span class="tag">                   <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!-- can have multi read hosts --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostS2"</span> <span class="attr">url</span>=<span class="string">"myhost:3308"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM2"</span> <span class="attr">url</span>=<span class="string">"myhost:3308"</span> <span class="attr">user</span>=<span class="string">"root"</span>  </span></span><br><span class="line"><span class="tag">                   <span class="attr">password</span>=<span class="string">"123456"</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line">以下为注释：</span><br><span class="line">name属性唯一标识dataHost标签，供上层的标签使用。</span><br><span class="line">maxCon属性指定每个读写实例连接池的最大连接。也就是说，标签内嵌套的</span><br><span class="line">writeHost、readHost标签都会使用这个属性的值来实例化出连接池的最大连接数。</span><br><span class="line">minCon属性指定每个读写实例连接池的最小连接，初始化连接池的大小。</span><br><span class="line"></span><br><span class="line">balance属性负载均衡类型，目前的取值有3种：</span><br><span class="line">1.balance="0",不开启读写分离机制，所有读操作都发送到当前可用的writeHost上。</span><br><span class="line">2.balance="1"，全部的readHost与stand by writeHost参与select语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与M2互为主备)，</span><br><span class="line">正常情况下，M2,S1,S2都参与select语句的负载均衡。</span><br><span class="line">3.balance="2"，所有读操作都随机的在writeHost、readhost上分发。</span><br><span class="line">4.balance="3"，所有读请求随机的分发到wiriterHost对应的readhost执行，</span><br><span class="line">writerHost不负担读压力，注意balance=3只在1.4及其以后版本有，1.3没有。</span><br><span class="line"></span><br><span class="line">writeType属性负载均衡类型，目前的取值有3种：</span><br><span class="line">1.writeType="0", 所有写操作发送到配置的第一个writeHost，第一个挂了切到还生存的第二个writeHost，重新启动后已切换后的为准，即第二个writeHost，切换记录在配置文件中:dnindex.properties.</span><br><span class="line">2.writeType="1"，所有写操作都随机的发送到配置的writeHost，1.5以后废弃不推荐。</span><br><span class="line">3.writeType="2"，不执行写操作</span><br><span class="line"></span><br><span class="line">switchType属性</span><br><span class="line">-1 表示不自动切换</span><br><span class="line">1 默认值，自动切换</span><br><span class="line">2 基于MySQL主从同步的状态决定是否切换</span><br><span class="line">3 基于MySQLgalarycluster的切换机制（适合集群）（1.4.1）</span><br><span class="line">心跳语句为show status like‘wsrep%’</span><br><span class="line"></span><br><span class="line">dbType属性</span><br><span class="line">指定后端连接的数据库类型，目前支持二进制的mysql协议，还有其他使用</span><br><span class="line">JDBC连接的数据库。例如：mongodb、oracle、spark等。</span><br><span class="line"></span><br><span class="line">dbDriver属性指定连接后端数据库使用的</span><br><span class="line">Driver，目前可选的值有native和JDBC。使用native的话，因为这个值执行的是二进制的mysql协议，所以可以使用mysql和maridb。其他类型的数据库则需要使用JDBC驱动来支持。从1.6版本开始支持postgresql的native原始协议。如果使用JDBC的话需要将符合JDBC 4标准的驱动JAR包放到MYCAT\lib目录下，并检查驱动JAR包中包括如下目录结构的文件：</span><br><span class="line">META-INF\services\java.sql.Driver。在这个文件内写上具体的Driver类名，例如：com.mysql.jdbc.Driver。</span><br><span class="line"></span><br><span class="line">heartbeat标签这个标签内指明用于和后端数据库进行心跳检查的语句。例如,MYSQL可以使用select user()，Oracle可以使用select 1 from dual等。这个标签还有一个</span><br><span class="line">connectionInitSql属性，主要是当使用Oracla数据库时，需要执行的初始化SQL</span><br><span class="line">语句就这个放到这里面来。例如：altersession set nls_date_format='yyyy-mm-dd hh24:mi:ss'</span><br><span class="line">1.4主从切换的语句必须是：showslave status</span><br></pre></td></tr></table></figure>
<p>改文件log4j2.xml为debug</p>
<p>启动mycat，并查看日志</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 本地文件夹 /Users/yaojie/Documents/docker/mycat/conf</span></span><br><span class="line"><span class="meta"># 本地文件夹 /Users/yaojie/Documents/docker/mycat/logs</span></span><br><span class="line">docker run --name mysql-mycat -v /Users<span class="meta-keyword">/yaojie/</span>Documents<span class="meta-keyword">/docker/</span>mycat/conf:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/mycat/</span>conf -v /Users<span class="meta-keyword">/yaojie/</span>Documents<span class="meta-keyword">/docker/</span>mycat/logs:<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/mycat/</span>logs -p <span class="number">8066</span>:<span class="number">8066</span> -p <span class="number">9066</span>:<span class="number">9066</span> debugman007/c7-mycat</span><br><span class="line"></span><br><span class="line"><span class="meta"># 8066端口是对数据进行操作，9066端口是控制端口</span></span><br></pre></td></tr></table></figure>
<p>用数据库连接工具连接8066端口，插入从3307，查询从3308端口。。事务的话都从3307端口。关闭主服务，从服务接管。</p>
<p><strong>redis集群</strong></p>
<p>首先下载镜像</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull <span class="keyword">redi</span><span class="variable">s:4</span>.<span class="number">0.1</span></span><br><span class="line">docker pull <span class="keyword">ruby</span></span><br></pre></td></tr></table></figure>
<p>创建自定义network</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker<span class="built_in"> network </span>create redis-net</span><br></pre></td></tr></table></figure>
<p>在本地文件夹/Users/yaojie/Documents/docker/redis/下创建redis-cluster.tmpl</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port <span class="variable">$&#123;PORT&#125;</span></span><br><span class="line"><span class="keyword">cluster</span>-enabled yes</span><br><span class="line"><span class="keyword">cluster</span>-config-<span class="keyword">file</span> nodes.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">cluster</span>-node-timeout 5000</span><br><span class="line"><span class="keyword">cluster</span>-announce-ip 具体ip地址</span><br><span class="line"><span class="keyword">cluster</span>-announce-port 192.168.1.169</span><br><span class="line"><span class="keyword">cluster</span>-announce-bus-port 1<span class="variable">$&#123;PORT&#125;</span></span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>
<p>linux下有envsubst命令时，创建文件夹7000到7005和子文件夹conf，data和conf下的配置文件，port已经替换</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="built_in"> port </span><span class="keyword">in</span> `seq 7000 7005`; <span class="keyword">do</span> \</span><br><span class="line">  mkdir -p ./<span class="variable">$&#123;port&#125;</span>/conf \</span><br><span class="line">  &amp;&amp; <span class="attribute">PORT</span>=<span class="variable">$&#123;port&#125;</span> envsubst &lt; ./redis-cluster.tmpl &gt; ./<span class="variable">$&#123;port&#125;</span>/conf/redis.conf \</span><br><span class="line">  &amp;&amp; mkdir -p ./<span class="variable">$&#123;port&#125;</span>/data; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>macos下没有envsubst命令，创建文件夹7000到7005和子文件夹conf，data和conf下的配置文件，再逐一改配置文件中的端口</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="built_in"> port </span><span class="keyword">in</span> `seq 7000 7005`; <span class="keyword">do</span> \</span><br><span class="line">  mkdir -p ./<span class="variable">$&#123;port&#125;</span>/conf \</span><br><span class="line">  &amp;&amp; cp ./redis-cluster.tmpl ./<span class="variable">$&#123;port&#125;</span>/conf/redis.conf \</span><br><span class="line">  &amp;&amp; mkdir -p ./<span class="variable">$&#123;port&#125;</span>/data; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>启动7000到7005的redis容器</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="built_in"> port </span><span class="keyword">in</span> `seq 7000 7005`; <span class="keyword">do</span> \</span><br><span class="line">  docker <span class="builtin-name">run</span> -d -ti -p <span class="variable">$&#123;port&#125;</span>:<span class="variable">$&#123;port&#125;</span> -p 1<span class="variable">$&#123;port&#125;</span>:1<span class="variable">$&#123;port&#125;</span> \</span><br><span class="line">  -v /Users/yaojie/Documents/docker/redis/<span class="variable">$&#123;port&#125;</span>/conf/redis.conf:/usr/local/etc/redis/redis.conf \</span><br><span class="line">  -v /Users/yaojie/Documents/docker/redis/<span class="variable">$&#123;port&#125;</span>/data:/data \</span><br><span class="line">  --restart always --name redis-<span class="variable">$&#123;port&#125;</span> --net redis-net \</span><br><span class="line">  --sysctl net.core.<span class="attribute">somaxconn</span>=1024 redis:4.0.1 redis-server /usr/local/etc/redis/redis.conf; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>以下是使用ruby集群redis，提供2种</p>
<p>第一种/Users/yaojie/Documents/docker/redis/下Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ruby</span><br><span class="line"><span class="keyword">MAINTAINER</span> yj</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> gem sources --remove https://rubygems.org/</span></span><br><span class="line"><span class="bash">RUN gem <span class="built_in">source</span> -a https://gems.ruby-china.org</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN gem install redis -v 4.0.1</span></span><br><span class="line"><span class="bash">ADD ./redis-4.0.1.tar.gz /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="bash">RUN <span class="built_in">cd</span> /usr/<span class="built_in">local</span> &amp;&amp; ln -s redis-4.0.1 redis</span></span><br></pre></td></tr></table></figure>
<p>创建镜像</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t yj/ruby_redis .</span><br></pre></td></tr></table></figure>
<p>启动容器</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -<span class="keyword">it</span> yj/ruby_redis /bin/bash</span><br></pre></td></tr></table></figure>
<p>启动集群</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis/src/redis-trib.rb create --replicas <span class="number">1</span> \</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.169</span>:<span class="number">7000</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.169</span>:<span class="number">7001</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.169</span>:<span class="number">7002</span> \</span><br><span class="line"><span class="number">192.168</span><span class="meta">.1</span><span class="meta">.169</span>:<span class="number">7003</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.169</span>:<span class="number">7004</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.169</span>:<span class="number">7005</span></span><br></pre></td></tr></table></figure>
<p>第二种，直接启动</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo yes | docker <span class="keyword">run</span> -i --<span class="keyword">rm</span> --<span class="keyword">net</span> redis-<span class="keyword">net</span> ruby <span class="keyword">sh</span> -c '\</span><br><span class="line">  gem sources --remove https:<span class="comment">//rubygems.org/ \</span></span><br><span class="line">  &amp;&amp; gem source -a https:<span class="comment">//gems.ruby-china.org \</span></span><br><span class="line">  &amp;&amp; gem install redis -v 4.0.1 \</span><br><span class="line">  &amp;&amp; wget http:<span class="comment">//download.redis.io/redis-stable/src/redis-trib.rb \</span></span><br><span class="line">  &amp;&amp; ruby redis-trib.rb create --replicas 1 \</span><br><span class="line">  '"$(<span class="keyword">for</span> port <span class="keyword">in</span> `seq 7000 7005`; <span class="keyword">do</span> \</span><br><span class="line">    echo -<span class="keyword">n</span> <span class="string">"$(docker inspect --format '&#123;&#123; (index .NetworkSettings.Networks "</span>redis-<span class="keyword">net</span><span class="string">").IPAddress &#125;&#125;' "</span>redis-<span class="variable">$&#123;port&#125;</span><span class="string">")"</span>:<span class="variable">$&#123;port&#125;</span> ' ' ; \</span><br><span class="line">  done)"</span><br></pre></td></tr></table></figure>
<p>再来说说单机或集群密码问题（暂不考虑）</p>
<p>java-springboot连接</p>
<p>jar</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>application.properties增加redis节点配置</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># REDIS（RedisProperties）</span></span><br><span class="line"><span class="meta"># （普通集群，不使用则不用开启）在群集中执行命令时要遵循的最大重定向数目。</span></span><br><span class="line"><span class="meta"># spring.redis.cluster.max-redirects=</span></span><br><span class="line"><span class="meta"># （普通集群，不使用则不用开启）以逗号分隔的“主机：端口”对列表进行引导。</span></span><br><span class="line"><span class="meta"># spring.redis.cluster.nodes=</span></span><br><span class="line"><span class="meta"># 连接工厂使用的数据库索引。</span></span><br><span class="line">spring.redis.database=<span class="number">0</span></span><br><span class="line"><span class="meta"># 可用以下分开来配置，连接URL，将覆盖主机，端口和密码（用户将被忽略），例如：redis://user:password@example.com:6379</span></span><br><span class="line">spring.redis.url=</span><br><span class="line"><span class="meta"># Redis服务器主机。</span></span><br><span class="line">spring.redis.host=localhost</span><br><span class="line"><span class="meta"># 登录redis服务器的密码。</span></span><br><span class="line">spring.redis.password=</span><br><span class="line"><span class="meta"># 启用SSL支持。</span></span><br><span class="line">spring.redis.ssl=<span class="literal">false</span></span><br><span class="line"><span class="meta"># 池在给定时间可以分配的最大连接数。使用负值无限制。</span></span><br><span class="line">spring.redis.jedis.pool.max-active=<span class="number">8</span></span><br><span class="line"><span class="meta"># 池中“空闲”连接的最大数量。使用负值表示无限数量的空闲连接。</span></span><br><span class="line">spring.redis.jedis.pool.max-idle=<span class="number">8</span></span><br><span class="line"><span class="meta"># 连接分配在池被耗尽时抛出异常之前应该阻塞的最长时间量（以毫秒为单位）。使用负值可以无限期地阻止。</span></span><br><span class="line">spring.redis.jedis.pool.max-wait=<span class="number">-1</span></span><br><span class="line"><span class="meta"># 目标为保持在池中的最小空闲连接数。这个设置只有在正面的情况下才有效果。</span></span><br><span class="line">spring.redis.jedis.pool.min-idle=<span class="number">0</span></span><br><span class="line"><span class="meta"># Redis服务器端口。</span></span><br><span class="line">spring.redis.port=<span class="number">6379</span></span><br><span class="line"><span class="meta"># （哨兵模式，不使用则不用开启）Redis服务器的名称。</span></span><br><span class="line"><span class="meta"># spring.redis.sentinel.master=</span></span><br><span class="line"><span class="meta"># （哨兵模式，不使用则不用开启）主机：端口对的逗号分隔列表。 </span></span><br><span class="line"><span class="meta"># spring.redis.sentinel.nodes=</span></span><br><span class="line"><span class="meta"># 以毫秒为单位的连接超时。0太小会超时</span></span><br><span class="line">spring.redis.timeout=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>说明：以上是单机版本的，如果是集群的只需要开启这两项(我们这里也用了这个配置)，密码还是使用<code>spring.redis.password</code>：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># （普通集群，不使用则不用开启）在群集中执行命令时要遵循的最大重定向数目。</span><br><span class="line">spring.redis.cluster.max-redirects=<span class="number">5</span></span><br><span class="line"># （普通集群，不使用则不用开启）以逗号分隔的“主机：端口”对列表进行引导。</span><br><span class="line">spring.redis.cluster.nodes=<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">7000</span>,<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">7001</span>,<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">7002</span>,<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">7003</span>,<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">7004</span>,<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">7005</span></span><br></pre></td></tr></table></figure>
<p>注意：一旦开启了集群模式，那么基于单机的配置就会覆盖</p>
<p>提示：可以这么说，上面的配置应该是最全的了。当然上面针对客户端的操作估计会比较少，比如哨兵模式，分片等等的，因为这些高可用在服务已经做了，如果想要在客户端实现这些，那么可以重新注入想要实现Bean即可。比如注入建立工厂，实现自己的Session。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码使用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(<span class="meta-string">"/aa"</span>)</span></span><br><span class="line"><span class="keyword">public</span> void <span class="keyword">init</span>() &#123;</span><br><span class="line">    redisTemplate.opsForValue().<span class="keyword">set</span>(<span class="string">"alais"</span>, <span class="string">"iouo"</span>);</span><br><span class="line">    System.<span class="keyword">out</span>.println(redisTemplate.opsForValue().<span class="keyword">get</span>(<span class="string">"alais"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用技巧：</p>
<p>在市面上可能存在两种个用法，1中是针对opsForValue，另一种是execute的，那么这两种的使用区别如下：</p>
<p>1、在redistemplate中配置Serializer</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ValueOperations<span class="variable">&lt;String, User&gt;</span> valueops = redisTemplate.opsForValue();</span><br><span class="line">valueops.<span class="built_in">set</span>(<span class="keyword">user</span>.getId(), <span class="keyword">user</span>);</span><br></pre></td></tr></table></figure>
<p>2、不在redistemplate中配置Serializer，而是在Service的实现类中单独指定Serializer。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">boolean</span> result = redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Boolean&gt;() &#123;</span><br><span class="line">      <span class="keyword">public</span> Boolean doInRedis(RedisConnection redisConnection) <span class="keyword">throws</span> DataAccessException &#123; </span><br><span class="line">          RedisSerializer&lt;<span class="keyword">String</span>&gt; redisSerializer = redisTemplate .getStringSerializer(); </span><br><span class="line">          <span class="built_in">byte</span>[] <span class="built_in">key</span> = redisSerializer.serialize(user.getId());</span><br><span class="line">          <span class="built_in">byte</span>[] value = redisSerializer.serialize(user.getName()); </span><br><span class="line">          <span class="keyword">return</span> redisConnection.setNX(<span class="built_in">key</span>, value); &#125; &#125;); </span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说这两者的区别的序列化是自己实现的。</p>
<p>可以一开始就@SpringBootApplication自定义redis的序列化</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    public RedisTemplate&lt;<span class="built_in">String</span>, ?&gt; redisTemplate(<span class="keyword">final</span> RedisConnectionFactory <span class="keyword">factory</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(<span class="keyword">factory</span>);</span><br><span class="line">        <span class="keyword">final</span> RedisSerializer&lt;<span class="built_in">String</span>&gt; stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();<span class="comment">//KEY只能存string，否则会报错;</span></span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义value的序列化方式</span></span><br><span class="line">        <span class="keyword">final</span> Jackson2JsonRedisSerializer&lt;?&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;<span class="built_in">Object</span>&gt;(<span class="built_in">Object</span>.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">final</span> ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"></span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>kakfa</strong></p>
<p>这里安装单机的kakfa，只要用于springboot的测试，</p>
<ol>
<li>docker pull wurstmeister/zookeeper  </li>
<li>docker pull wurstmeister/kafka  </li>
<li>docker run -d –name zookeeper -p 2181 -t wurstmeister/zookeeper  </li>
<li>docker run -d –name kafka -p 9092:9092 –link zookeeper:zk -e KAFKA_ZOOKEEPER_CONNECT=zk:2181 -e KAFKA_ADVERTISED_HOST_NAME=127.0.0.1 -e KAFKA_ADVERTISED_PORT=9092 wurstmeister/kafka</li>
</ol>
<p>测试是否成功</p>
<ol>
<li>docker exec -it ${CONTAINER ID} /bin/bash   </li>
<li>cd opt/kafka_2.11-0.10.1.1/   </li>
<li>创建一个主题：bin/kafka-topics.sh –create –zookeeper zookeeper:2181 –replication-factor 1 –partitions 1 –topic mykafka</li>
<li>运行一个消息生产者，指定topic为刚刚创建的主题:bin/kafka-console-producer.sh –broker-list localhost:9092 –topic mykafka  </li>
<li>运行一个消费者，指定同样的主题:bin/kafka-console-consumer.sh –zookeeper zookeeper:2181 –topic mykafka –from-beginning </li>
</ol>
<p><strong>代码编写</strong></p>
<p>sts创建springboot项目很简单，目前最新2.0.1版本</p>
<p>需要联网,点击File&gt;&gt;New&gt;&gt;Spring Start Project</p>
<p>跳出Service Url（<a href="http://start.spring.io）填写" target="_blank" rel="noopener">http://start.spring.io）填写</a></p>
<ul>
<li>Name(springboot-study)</li>
<li>Group(com.example)</li>
<li>Artifact(springboot-study)</li>
<li>Version(0.0.1-SNAPSHOT)</li>
<li>Package(com.example.demo)</li>
<li>Type(Maven)</li>
<li>Java Version(8)</li>
<li>Package(Jar)</li>
<li>Language(Java)</li>
</ul>
<p>点击下一步，让我们选择使用的jar</p>
<p>我们这里一步一步添加jar包，我们先勾上Web，点击finish。第一次会下载jar，等待下载完之后，项目目录就好了。</p>
<p>我们先把基础的package名字建好，</p>
<ul>
<li>com.example.demo.controller</li>
<li>com.example.demo.service</li>
<li>com.example.demo.dao</li>
<li>com.example.demo.dto</li>
<li>com.example.demo.util</li>
<li>com.example.demo.client</li>
<li>com.example.demo.task</li>
</ul>
<p>(1) 引入mybatis+mysql</p>
<p>数据库中创建表</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE <span class="keyword">IF</span> EXISTS `person`;</span><br><span class="line">CREATE TABLE `person` (</span><br><span class="line">  `id` int(11) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(50)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `age` int(11)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `sex` int(11)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>pom.xml中引入jar</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将application.properties改成application.yml格式，可以不改</p>
<p>添加mybatis和mysql配置</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server</span>:</span><br><span class="line">  <span class="attribute">port</span>: <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">spring</span>:</span><br><span class="line">  <span class="attribute">datasource</span>:</span><br><span class="line">    <span class="attribute">driver-class-name</span>: com.mysql.jdbc.Driver</span><br><span class="line">    <span class="attribute">url</span>: <span class="attribute">jdbc</span>:<span class="attribute">mysql</span>:<span class="comment">//localhost:8066/TESTDB?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;autoReconnect=true</span></span><br><span class="line">    <span class="attribute">username</span>: root</span><br><span class="line">    <span class="attribute">password</span>: <span class="number">123456</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">mybatis</span>: </span><br><span class="line">  <span class="attribute">mapper-locations</span>:</span><br><span class="line">  - <span class="attribute">classpath</span>:mapper<span class="comment">/*Mapper.xml</span></span><br></pre></td></tr></table></figure>
<p>在SpringbootStudyApplication上添加</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@MapperScan</span>(<span class="string">"com.example.demo.dao"</span>)  指定扫描的dao处理地址</span><br><span class="line"><span class="variable">@EnableTransactionManagement</span>   开启事务机制</span><br></pre></td></tr></table></figure>
<p>创建对于的dto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Serializable序列化为了之后的redisCache存入redis的，单mybatis可以不加</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer sex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">final</span> Integer id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">final</span> Integer age)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(<span class="keyword">final</span> Integer sex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.dto.Person;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @Mapper 等同于@MapperScan(..)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以直接在这里写sql处理</span></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"insert into person(id, name, age, sex) values (#&#123;id&#125;,#&#123;name&#125;,#&#123;age&#125;,#&#123;sex&#125;)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertOne</span><span class="params">(Person person)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from person where id = #&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">Person <span class="title">findOne</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 也可以去xml中处理语句</span></span><br><span class="line">    <span class="function">List&lt;Person&gt; <span class="title">searchAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于searchAll是从xml解析的sql。我们配置了<code>classpath:mapper/*Mapper.xml</code>，所以在resources下创建mapper文件夹，并在文件夹中创建personMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.demo.dao.PersonDao"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"searchAll"</span> <span class="attr">resultType</span>=<span class="string">"com.example.demo.dto.Person"</span>&gt;</span></span><br><span class="line">    select * from person</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>创建对于的service和controller</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.dao.PersonDao;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.dto.Person;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PersonDao personDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Person <span class="title">insertOne</span><span class="params">(<span class="keyword">final</span> Person person)</span> </span>&#123;</span><br><span class="line">        personDao.insertOne(person);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">        <span class="comment">//        Integer.parseInt("sssss");</span></span><br><span class="line">        <span class="comment">//        personDao.insertOne(person);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Person <span class="title">findOne</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">return</span> personDao.<span class="title">findOne</span><span class="params">(id)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">deleteOne</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; searchAll() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">return</span> personDao.<span class="title">searchAll</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">com</span><span class="selector-class">.example</span><span class="selector-class">.demo</span><span class="selector-class">.controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">java</span><span class="selector-class">.util</span><span class="selector-class">.List</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">javax</span><span class="selector-class">.annotation</span><span class="selector-class">.Resource</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.PathVariable</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.RequestBody</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.RequestMapping</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.RestController</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">com</span><span class="selector-class">.example</span><span class="selector-class">.demo</span><span class="selector-class">.dto</span><span class="selector-class">.Person</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">com</span><span class="selector-class">.example</span><span class="selector-class">.demo</span><span class="selector-class">.service</span><span class="selector-class">.PersonService</span>;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">RestController</span></span><br><span class="line"><span class="keyword">public</span> class PersonController &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Resource</span></span><br><span class="line">    private PersonService personService;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">RequestMapping</span>("/<span class="keyword">insertOne</span>")</span><br><span class="line">    public void insertOne(@RequestBody final Person person) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="selector-tag">personService</span><span class="selector-class">.insertOne</span>(<span class="selector-tag">person</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">RequestMapping</span>("/&#123;<span class="selector-tag">id</span>&#125;")</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">Person</span> <span class="selector-tag">findOne</span>(@<span class="keyword">PathVariable</span> final int id) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">personService</span><span class="selector-class">.findOne</span>(<span class="selector-tag">id</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">RequestMapping</span>("/<span class="keyword">deleteOne</span>/&#123;<span class="selector-tag">id</span>&#125;")</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">deleteOne</span>(@<span class="keyword">PathVariable</span> final int id) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="selector-tag">personService</span><span class="selector-class">.deleteOne</span>(<span class="selector-tag">id</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">RequestMapping</span>("/<span class="keyword">searchAll</span>")</span><br><span class="line">    public List&lt;Person&gt; searchAll() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">personService</span><span class="selector-class">.searchAll</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们可以运行，run as &gt;&gt; spring boot app ，查看运行成功</p>
<p>调用POST <a href="http://localhost:8080/insertOne" target="_blank" rel="noopener">http://localhost:8080/insertOne</a></p>
<p>报文</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">	<span class="attr">"name"</span>: <span class="string">"namess"</span>,</span><br><span class="line">	<span class="attr">"age"</span>: <span class="number">22</span>,</span><br><span class="line">	<span class="attr">"sex"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用GET <a href="http://localhost:8080/2" target="_blank" rel="noopener">http://localhost:8080/2</a> ，<a href="http://localhost:8080/searchAll" target="_blank" rel="noopener">http://localhost:8080/searchAll</a> 都成功了</p>
<p>（2）考虑到分页实现，我们引用开源的分页插件pagehelper</p>
<p>pom.xml中引入jar</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 分页插件pagehelper --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 分页插件pagehelper --&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置分页插件pagehelper</span></span><br><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line"><span class="attr">  helperDialect:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  reasonable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  supportMethodsArguments:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  params:</span> <span class="string">count=countSql</span></span><br></pre></td></tr></table></figure>
<p>dao层加入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select</span>(<span class="string">"select * from person"</span>)</span><br><span class="line"><span class="function">Page&lt;Person&gt; <span class="title">findByPage</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>service层加入</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.page.PageMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Page&lt;Person&gt; searchPage(<span class="keyword">final</span> <span class="keyword">int</span> pageNo, <span class="keyword">final</span> <span class="keyword">int</span> pageSize) &#123;</span><br><span class="line"></span><br><span class="line">    PageMethod.startPage(pageNo, pageSize);</span><br><span class="line">    <span class="function"><span class="keyword">return</span> personDao.<span class="title">findByPage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于分页插件自带的Page不能用作返回，我们在dto封装我们的PageInfo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageInfo</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前页</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pageNum;</span><br><span class="line">    <span class="comment">//每页的数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pageSize;</span><br><span class="line">    <span class="comment">//总记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> total;</span><br><span class="line">    <span class="comment">//总页数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pages;</span><br><span class="line">    <span class="comment">//结果集</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line">    <span class="comment">//是否为第一页</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstPage = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//是否为最后一页</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isLastPage = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 包装Page对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageInfo</span><span class="params">(<span class="keyword">final</span> List&lt;T&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (list <span class="keyword">instanceof</span> Page) &#123;</span><br><span class="line">            <span class="keyword">final</span> Page page = (Page) list;</span><br><span class="line">            <span class="keyword">this</span>.pageNum = page.getPageNum();</span><br><span class="line">            <span class="keyword">this</span>.pageSize = page.getPageSize();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.pages = page.getPages();</span><br><span class="line">            <span class="keyword">this</span>.list = page;</span><br><span class="line">            <span class="keyword">this</span>.total = page.getTotal();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (list <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pageNum = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">this</span>.pageSize = list.size();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.pages = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">this</span>.list = list;</span><br><span class="line">            <span class="keyword">this</span>.total = list.size();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (list <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">            <span class="comment">//判断页面边界</span></span><br><span class="line">            judgePageBoudary();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判定页面边界</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">judgePageBoudary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isFirstPage = pageNum == <span class="number">1</span>;</span><br><span class="line">        isLastPage = pageNum == pages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPageNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pageNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPageNum</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> pageNum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pageNum = pageNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPageSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPageSize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> pageSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTotal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotal</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> total)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.total = total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPages</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> pages)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pages = pages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setList</span><span class="params">(<span class="keyword">final</span> List&lt;T&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIsFirstPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isFirstPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsFirstPage</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isFirstPage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isFirstPage = isFirstPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIsLastPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isLastPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsLastPage</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isLastPage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isLastPage = isLastPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">"PageInfo&#123;"</span>);</span><br><span class="line">        sb.append(<span class="string">"pageNum="</span>).append(pageNum);</span><br><span class="line">        sb.append(<span class="string">", pageSize="</span>).append(pageSize);</span><br><span class="line">        sb.append(<span class="string">", total="</span>).append(total);</span><br><span class="line">        sb.append(<span class="string">", pages="</span>).append(pages);</span><br><span class="line">        sb.append(<span class="string">", list="</span>).append(list);</span><br><span class="line">        sb.append(<span class="string">", isFirstPage="</span>).append(isFirstPage);</span><br><span class="line">        sb.append(<span class="string">", isLastPage="</span>).append(isLastPage);</span><br><span class="line">        sb.append(<span class="string">", navigatepageNums="</span>);</span><br><span class="line">        sb.append(<span class="string">'&#125;'</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>controller</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.demo.dto.PageInfo;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.dto.Person;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.service.PersonService;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/searchPage/&#123;pageNo&#125;/&#123;pageSize&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> PageInfo&lt;Person&gt; searchPage(<span class="meta">@PathVariable</span> <span class="keyword">final</span> <span class="keyword">int</span> pageNo, <span class="meta">@PathVariable</span> <span class="keyword">final</span> <span class="keyword">int</span> pageSize) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Page&lt;Person&gt; persons = personService.searchPage(pageNo, pageSize);</span><br><span class="line">    <span class="keyword">final</span> PageInfo&lt;Person&gt; pageInfo = <span class="keyword">new</span> PageInfo&lt;&gt;(persons);</span><br><span class="line">    <span class="keyword">return</span> pageInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用GET <a href="http://localhost:8080/searchPage/1/1" target="_blank" rel="noopener">http://localhost:8080/searchPage/1/1</a> 即可看到分页成功</p>
<p>（3）为了看运行的sql语句等，我们加入log日志</p>
<p>Pom.xml中加入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件加入</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">loggin<span class="variable">g:</span></span><br><span class="line">  leve<span class="variable">l:</span></span><br><span class="line">    <span class="keyword">com</span>.example.demo.dao: DEBUG</span><br><span class="line">  <span class="keyword">file</span>: /Users/yaojie/Desktop/demo.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>默认每天压缩前一天日志，生成一个新的日志。</p>
<p>这样我们就能在控制台看到具体的sql</p>
<p>（4）redis集成</p>
<p>pom.xml中jar</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件在spring下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">spring</span>:   </span><br><span class="line">  <span class="selector-tag">redis</span>:</span><br><span class="line">    <span class="selector-tag">cluster</span>:</span><br><span class="line">      <span class="selector-tag">max-redirects</span>: 5</span><br><span class="line">      <span class="selector-tag">nodes</span>: 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:7000</span>,127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:7001</span>,127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:7002</span>,127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:7003</span>,127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:7004</span>,127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:7005</span></span><br><span class="line">    <span class="selector-tag">database</span>: 0</span><br><span class="line">    <span class="selector-tag">password</span>: </span><br><span class="line">    <span class="selector-tag">ssl</span>: <span class="selector-tag">false</span></span><br><span class="line">    <span class="selector-tag">jedis</span>:</span><br><span class="line">      <span class="selector-tag">pool</span>:</span><br><span class="line">        <span class="selector-tag">max-active</span>: 8</span><br><span class="line">        <span class="selector-tag">max-idle</span>: 8</span><br><span class="line">        <span class="selector-tag">max-wait</span>: <span class="selector-tag">-1</span></span><br><span class="line">        <span class="selector-tag">min-idle</span>: 0</span><br><span class="line">    # 配置了<span class="selector-tag">cluster</span>集群 单独的配置自动失效</span><br><span class="line">    <span class="selector-tag">host</span>: 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span></span><br><span class="line">    <span class="selector-tag">port</span>: 6900</span><br><span class="line">    <span class="selector-tag">timeout</span>: 5000</span><br></pre></td></tr></table></figure>
<p>SpringbootDemoApplication中配置redis的序列化，使查看值和key的时候更加方便，需要存redis的实体需要序列化</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    public RedisTemplate&lt;<span class="built_in">String</span>, ?&gt; redisTemplate(<span class="keyword">final</span> RedisConnectionFactory <span class="keyword">factory</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(<span class="keyword">factory</span>);</span><br><span class="line">        <span class="keyword">final</span> RedisSerializer&lt;<span class="built_in">String</span>&gt; stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();<span class="comment">//Long类型不可以会出现异常信息;</span></span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义value的序列化方式</span></span><br><span class="line">        <span class="keyword">final</span> Jackson2JsonRedisSerializer&lt;?&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;<span class="built_in">Object</span>&gt;(</span><br><span class="line">                <span class="built_in">Object</span>.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">final</span> ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"></span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>引用RedisTemplate即可使用redis</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; redisTemplate;</span><br></pre></td></tr></table></figure>
<p>（5）springsession redis共享</p>
<p>pom.xml中加入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- springsession redis共享 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>SpringbootStudyApplication中配置</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800)</span><span class="comment">//SpringSession时间1800s</span></span><br></pre></td></tr></table></figure>
<p>util下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpSessionUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpSession <span class="title">getHttpSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        HttpSession httpSession = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder</span><br><span class="line">                .currentRequestAttributes();</span><br><span class="line">        httpSession = requestAttributes.getRequest().getSession();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> httpSession;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>controller中加入</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/setSession"</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       HttpSessionUtil.getHttpSession().setAttribute(<span class="string">"userToken"</span>, <span class="string">"userTokenxxxxxxxxxxxxx"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">"/getSession"</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="function">Object <span class="title">getSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> HttpSessionUtil.getHttpSession().getAttribute(<span class="string">"userToken"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这样springboot的集群起不同端口，分布式都可以共享session了</p>
<p>（6）使用redis-cache</p>
<p>pom.xml加入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">spring:</span> </span><br><span class="line"><span class="symbol">  cache:</span></span><br><span class="line"><span class="symbol">    type:</span> redis</span><br></pre></td></tr></table></figure>
<p>SpringbootStudyApplication</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span><span class="comment">//使用redis的话需要序列化实体</span></span><br></pre></td></tr></table></figure>
<p>service修改</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.<span class="keyword">annotation</span>.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.<span class="keyword">annotation</span>.CachePut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.<span class="keyword">annotation</span>.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.<span class="keyword">annotation</span>.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.dao.PersonDao;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.dto.Person;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.page.PageMethod;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PersonDao personDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="comment">// 将返回数据插入缓存</span></span><br><span class="line">    <span class="meta">@CachePut(key=<span class="meta-string">"#person.id"</span>, value=<span class="meta-string">"person"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Person insertOne(<span class="keyword">final</span> Person person) &#123;</span><br><span class="line">        personDao.insertOne(person);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">        <span class="comment">//        Integer.parseInt("sssss");</span></span><br><span class="line">        <span class="comment">//        personDao.insertOne(person);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找缓存，有返回，没有调用方法，将值存入缓存</span></span><br><span class="line">    <span class="meta">@Cacheable(key=<span class="meta-string">"#id"</span>, value=<span class="meta-string">"person"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Person findOne(<span class="keyword">final</span> int id) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> personDao.findOne(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@CacheEvict 删除缓存</span></span><br><span class="line">    <span class="meta">@CacheEvict(key=<span class="meta-string">"#id"</span>, value=<span class="meta-string">"person"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> void deleteOne(<span class="keyword">final</span> int id) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; searchAll() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> personDao.searchAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Page&lt;Person&gt; searchPage(<span class="keyword">final</span> int pageNo, <span class="keyword">final</span> int pageSize) &#123;</span><br><span class="line"></span><br><span class="line">        PageMethod.startPage(pageNo, pageSize);</span><br><span class="line">        <span class="keyword">return</span> personDao.findByPage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（7）定时任务</p>
<p>使用spring3之后的Scheduling</p>
<p>SpringbootStudyApplication加上</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableScheduling</span></span><br></pre></td></tr></table></figure>
<p>task下，由于集群多个部署会多次执行，由业务控制执行一次，以下用redis</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.<span class="keyword">annotation</span>.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.<span class="keyword">annotation</span>.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.client.RedisClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(PersonTask.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisClient redisClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 定时任务执行结束才能下一次执行，redis控制集群并发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @Async 不添加则直接单线程执行定时任务，顺序执行，集群后需要每次触发，控制由redis</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 5000)</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> void taskTwo() &#123;</span><br><span class="line"></span><br><span class="line">        System.<span class="keyword">out</span>.println(Thread.currentThread().getName() + <span class="string">"======taskTwo===="</span>);</span><br><span class="line">        <span class="keyword">if</span> (redisClient.<span class="keyword">get</span>(<span class="string">"taskTwoKey"</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (redisClient.<span class="keyword">set</span>(<span class="string">"taskTwoKey"</span>, <span class="string">"value"</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 定时任务执行</span></span><br><span class="line">                    System.<span class="keyword">out</span>.println(Thread.currentThread().getName() + <span class="string">"----333------"</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"taskOne定时任务异常"</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.<span class="keyword">out</span>.println(</span><br><span class="line">                            Thread.currentThread().getName() + <span class="string">"----redisClient.remove(\"taskTwoKey\");------"</span>);</span><br><span class="line">                    redisClient.remove(<span class="string">"taskTwoKey"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client下</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line"><span class="keyword">public</span> class RedisClient &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(<span class="string">"boxing"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> setIfNotExsit(<span class="keyword">final</span> <span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">final</span> <span class="keyword">Object</span> value) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().setIfAbsent(<span class="built_in">key</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(<span class="string">"boxing"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> setIfNotExsit(<span class="keyword">final</span> <span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">final</span> <span class="keyword">String</span> value, <span class="keyword">final</span> <span class="built_in">int</span> <span class="built_in">second</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">boolean</span> bool = redisTemplate.opsForValue().setIfAbsent(<span class="built_in">key</span>, value);</span><br><span class="line">        redisTemplate.expire(<span class="built_in">key</span>, <span class="built_in">second</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">Object</span> <span class="built_in">get</span>(<span class="keyword">final</span> <span class="keyword">String</span> <span class="built_in">key</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().<span class="built_in">get</span>(<span class="built_in">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> remove(<span class="keyword">final</span> <span class="keyword">String</span> <span class="built_in">key</span>) &#123;</span><br><span class="line"></span><br><span class="line">        redisTemplate.delete(<span class="built_in">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（8）kakfa</p>
<p>pom.xml中jar</p>
<p>这里我使用的spring-kafka（它包装了apache的kafka-client）使用的kafka的时候要注意，kafka客户端（kafka-client）的版本要和kafka服务器的版本一一对应，否则，消息发送会失败。具体: <a href="https://projects.spring.io/spring-kafka/" target="_blank" rel="noopener">https://projects.spring.io/spring-kafka/</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>属性文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">spring</span>:    </span><br><span class="line">  <span class="selector-tag">kafka</span>:</span><br><span class="line">    <span class="selector-tag">producer</span>:</span><br><span class="line">      <span class="selector-tag">bootstrap-servers</span>:</span><br><span class="line">      <span class="selector-tag">-</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:9092</span></span><br></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> KafkaTemplate&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">kafkaTemplate.send(<span class="string">"test"</span>, <span class="string">"这是一个测试kafka的消息"</span> + <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br></pre></td></tr></table></figure>
<p>消费者</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaConsumer</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(KafkaConsumer.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听test主题,有消息就读取</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@KafkaListener</span>(topics = &#123;<span class="string">"test"</span>&#125;,groupId=<span class="string">"testGroup"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> consumer(<span class="keyword">final</span> String message)&#123;</span><br><span class="line"></span><br><span class="line">        LOGGER.info(<span class="string">"test topic message : &#123;&#125;"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码：<a href="https://pan.baidu.com/s/1EpXrBR7DHv0zkGinD6qVUQ" target="_blank" rel="noopener">百度网盘</a></p>
</div><div class="tags"><a href="/tags/部署/">部署</a></div><div class="post-nav"><a class="pre" href="/2018/08/24/other/redisDealwithNull/">切面防止redis的穿透问题</a><a class="next" href="/2018/04/10/springboot/005.springboot web/">005 springboot的web配置</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/springMvc/">springMvc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/springboot/">springboot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/springcloud/">springcloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂记/">杂记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/部署/" style="font-size: 15px;">部署</a> <a href="/tags/es/" style="font-size: 15px;">es</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/定时任务/" style="font-size: 15px;">定时任务</a> <a href="/tags/工具类/" style="font-size: 15px;">工具类</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/02/docker/docker-compose install tools/">docker-compose 安装工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/02/docker/docker cmd/">docker 基础命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/02/docker/install docker/">docker/docker-compose安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/11/other/docker in out/">docker 简单操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/11/other/elastic search dump/">es 简单操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/other/linux operator/">linux常规操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/24/other/git operator/">git操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/26/springboot/sharding jdbc/">springboot2.0.6使用sharding jdbc3.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/springboot/tip-springboot tip/">springboot一些方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/08/docker/docker install tools/">docker安装工具</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">雨中风筝.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>